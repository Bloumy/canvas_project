(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var Key=require("./Key");var Directions=require("./Directions");function Controles(map){this.i=0;this.map=map;this.directions=new Directions;this.initCommandeKey()}Controles.prototype.initCommandeKey=function(){var k=new Key;this.keys=k};Controles.prototype.assignKeybordToChar=function(char){var self=this;document.addEventListener("activatekey",function(e){self.activateCharCommande(char)});document.addEventListener("deactivatekey",function(e){self.activateCharCommande(char)})};Controles.prototype.activateCharCommande=function(char){var keys=this.keys.getKeysActivated();var keysReverse=this.swap(keys);var d=this.directions;var key=this.keys.KEY;if(key.up in keysReverse&&key.right in keysReverse){char.deplacer(45,this.map);return true}if(key.down in keysReverse&&key.right in keysReverse){char.deplacer(315,this.map);return true}if(key.up in keysReverse&&key.left in keysReverse){char.deplacer(135,this.map);return true}if(key.down in keysReverse&&key.left in keysReverse){char.deplacer(225,this.map);return true}if(key.up in keysReverse){char.deplacer(90,this.map);return true}if(key.right in keysReverse){char.deplacer(0,this.map);return true}if(key.down in keysReverse){char.deplacer(270,this.map);return true}if(key.left in keysReverse){char.deplacer(180,this.map);return true}char.doNothing();return false};Controles.prototype.swap=function(array){var ret={};for(var key in array){ret[array[key]]=key}return ret};module.exports=Controles},{"./Directions":2,"./Key":3}],2:[function(require,module,exports){function Directions(){}Directions.prototype.DIRECTION={BAS:0,GAUCHE:1,DROITE:2,HAUT:3};module.exports=Directions},{}],3:[function(require,module,exports){function Key(){this.initKeyMap()}Key.prototype.KEY={left:37,up:38,right:39,down:40,A:65,D:68,Q:81,S:83,W:87,Z:90,a:97,d:100,q:113,s:115,w:119,z:122};Key.prototype.KEY_REVERSE={37:"left",38:"up",39:"right",40:"down",65:"A",68:"D",81:"Q",83:"S",87:"W",90:"Z",97:"a",100:"d",113:"q",115:"s",119:"w",122:"z"};Key.prototype.initKeyMap=function(){this.keyMap=[];for(var key in this.KEY_REVERSE){this.keyMap[key]=false}var self=this;var eventKeyDown=new CustomEvent("activatekey");window.onkeydown=function(e){if(e.keyCode in self.KEY_REVERSE&&self.keyMap[e.keyCode]!=true){self.keyMap[e.keyCode]=true;eventKeyDown.keyCode=e.which||e.keyCode;eventKeyDown.key=self.KEY_REVERSE[e.keyCode];eventKeyDown.keysActivated=self.getKeysActivated();document.dispatchEvent(eventKeyDown)}};var eventKeyUp=new CustomEvent("deactivatekey");window.onkeyup=function(e){if(e.keyCode in self.KEY_REVERSE&&self.keyMap[e.keyCode]!=false){self.keyMap[e.keyCode]=false;eventKeyUp.keyCode=e.which||e.keyCode;eventKeyUp.key=self.KEY_REVERSE[e.keyCode];eventKeyUp.keysActivated=self.getKeysActivated();document.dispatchEvent(eventKeyUp)}}};Key.prototype.getKeysActivated=function(){var activatedKeys=[];for(var key in this.KEY_REVERSE){if(this.keyMap[key]==true){activatedKeys.push(key)}}return activatedKeys};module.exports=Key},{}],4:[function(require,module,exports){var XHR=require("./XHR");var Tileset=require("./Tileset");var Map=function(nom){this.TAILLE_CASE_EN_PX=32;var xhr=new XHR;xhr.open("GET","./maps/"+nom+".json",false);xhr.send(null);if(xhr.readyState!=4||xhr.status!=200&&xhr.status!=0)throw new Error('Impossible de charger la carte nommée "'+nom+'" (code HTTP : '+xhr.status+").");var mapJsonData=xhr.responseText;var mapData=JSON.parse(mapJsonData);this.tileset=new Tileset(mapData.tileset);this.terrain=mapData.terrain;this.personnages=new Array};Map.prototype.getHauteur=function(){return this.terrain.length};Map.prototype.getLargeur=function(){return this.terrain[0].length};Map.prototype.dessinerMap=function(context){for(var i=0,l=this.terrain.length;i<l;i++){var ligne=this.terrain[i];var y=i*this.TAILLE_CASE_EN_PX;for(var j=0,k=ligne.length;j<k;j++){this.tileset.dessinerTile(ligne[j],context,j*this.TAILLE_CASE_EN_PX,y)}}for(var i=0,l=this.personnages.length;i<l;i++){this.personnages[i].dessinerPersonnage(context)}};Map.prototype.dessinerMapBoucleAuto=function(context,milisecondes){var self=this;setInterval(function(){self.dessinerMap(context)},milisecondes)};Map.prototype.isObstacle=function(coord){if(coord.x<0){return true}if(coord.y<0){return true}if(coord.x>=(this.getLargeur()-1)*this.TAILLE_CASE_EN_PX){return true}var tailleSprite=48;if(coord.y>=(this.getHauteur()-(1+(tailleSprite-this.TAILLE_CASE_EN_PX)/this.TAILLE_CASE_EN_PX))*this.TAILLE_CASE_EN_PX){return true}return false};Map.prototype.addPersonnage=function(perso){this.personnages.push(perso)};module.exports=Map},{"./Tileset":6,"./XHR":7}],5:[function(require,module,exports){var Directions=require("./Directions");function Personnage(url,x,y,direction){this.FRAME_PAR_CASE=1;this.NB_PX_DEPLACEMENT=4;this.CASES_PAR_SECONDE=4;this.DEFAULT_VITESSE=this.CASES_PAR_SECONDE/this.NB_PX_DEPLACEMENT*32;var d=new Directions;this.DIRECTIONS=d.DIRECTION;this.vitesse=this.DEFAULT_VITESSE;this.xPixel=x*32;this.yPixel=y*32;this.direction=direction;this.image=new Image;this.image.referenceDuPerso=this;this.image.src="sprites/"+url;this.largeur=this.image.width/4;this.hauteur=this.image.height/4;this.frame=0;this.interval=null;return this}Personnage.prototype.dessinerPersonnage=function(context){context.drawImage(this.image,this.largeur*this.frame,this.direction*this.hauteur,this.largeur,this.hauteur,this.xPixel,this.yPixel,this.largeur,this.hauteur)};Personnage.prototype.getCoordonneesAdjacentes=function(angle,nbPx){if(nbPx===undefined||nbPx===null){nbPx=this.NB_PX_DEPLACEMENT}var coord={x:null,y:null};coord.x=Math.round(this.xPixel+nbPx*Math.cos(angle*(2*Math.PI)/360));coord.y=Math.round(this.yPixel+nbPx*Math.sin(-angle*(2*Math.PI)/360));return coord};Personnage.prototype.deplacerEnPx=function(angle,map,nbPx){if(45<=angle&&angle<=135){this.direction=this.DIRECTIONS.HAUT}if(0<=angle&&angle<45||315<angle&&angle<=360){this.direction=this.DIRECTIONS.DROITE}if(225<=angle&&angle<=315){this.direction=this.DIRECTIONS.BAS}if(135<angle&&angle<225){this.direction=this.DIRECTIONS.GAUCHE}var coordDestination=this.getCoordonneesAdjacentes(angle,nbPx);console.log("x = "+this.xPixel);console.log("y = "+this.yPixel);if(map.isObstacle(coordDestination)){return false}this.xPixel=coordDestination.x;this.yPixel=coordDestination.y;return true};Personnage.prototype.doNothing=function(){clearInterval(this.interval);this.frame=0};Personnage.prototype.deplacer=function(angle,map,nbPx){clearInterval(this.interval);this.frame=0;if(nbPx===undefined||nbPx===null){var d=map.TAILLE_CASE_EN_PX;var v=this.vitesse;v=v*32;var t=d/v;var millisecondes=t*1e3;var nbPx=this.NB_PX_DEPLACEMENT;var distance_pour_une_frame=map.TAILLE_CASE_EN_PX/this.FRAME_PAR_CASE;var self=this;this.deplacerEnPx(angle,map,nbPx);this.frame++;var pxParcourus=0;this.interval=setInterval(function(){self.deplacerEnPx(angle,map,nbPx);if(pxParcourus>=distance_pour_une_frame){self.frame++;pxParcourus=0}if(self.frame>3){self.frame%=4}pxParcourus+=nbPx},millisecondes)}else{this.deplacerEnPx(angle,map,nbPx)}};module.exports=Personnage},{"./Directions":2}],6:[function(require,module,exports){function Tileset(url){this.image=new Image;this.image.referenceDuTileset=this;this.image.onload=function(){if(!this.complete){throw new Error('Erreur de chargement du tileset nommé "'+url+'".')}this.referenceDuTileset.largeur=this.width/32};this.image.src="tilesets/"+url}Tileset.prototype.dessinerTile=function(numero,context,xDestination,yDestination){var xSourceEnTiles=numero%this.largeur;if(xSourceEnTiles==0){xSourceEnTiles=this.largeur}var ySourceEnTiles=Math.ceil(numero/this.largeur);var xSource=(xSourceEnTiles-1)*32;var ySource=(ySourceEnTiles-1)*32;context.drawImage(this.image,xSource,ySource,32,32,xDestination,yDestination,32,32)};module.exports=Tileset},{}],7:[function(require,module,exports){var XHR=function(){return this.getXMLHttpRequest()};XHR.prototype.getXMLHttpRequest=function(){var xhr=null;if(window.XMLHttpRequest||window.ActiveXObject){if(window.ActiveXObject){try{xhr=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){xhr=new ActiveXObject("Microsoft.XMLHTTP")}}else{xhr=new XMLHttpRequest}}else{alert("Votre navigateur ne supporte pas l'objet XMLHTTPRequest...");return null}return xhr};module.exports=XHR},{}],8:[function(require,module,exports){var Directions=require("./classes/Directions");var Map=require("./classes/Map");var Personnage=require("./classes/Personnage");var Controles=require("./classes/Controles");var map=new Map("floor1");var directions=new Directions;var controles=new Controles(map);var hero=new Personnage("hero.png",1,1,directions.DIRECTION.HAUT);window.onload=function(){var canvas=document.getElementById("canvas");var ctx=canvas.getContext("2d");canvas.width=map.getLargeur()*32;canvas.height=map.getHauteur()*32;map.addPersonnage(hero);controles.assignKeybordToChar(hero);map.dessinerMapBoucleAuto(ctx,40)}},{"./classes/Controles":1,"./classes/Directions":2,"./classes/Map":4,"./classes/Personnage":5}]},{},[8]);
